<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>ESP32 WebGL Test</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }
      
      html, body {
        width: 100%;
        height: 100%;
        background: #000;
        font-family: monospace; /* –ù–û–í–û–ï: –®—Ä–∏—Ñ—Ç –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ */
        color: #ccc;
      }
      
      #unity-container {
        width: 100%;
        height: 100%;
        background: #000;
      }
      
      #unity-canvas {
        width: 100% !important;
        height: 100% !important;
        background: #000;
      }
      
      /* –ù–û–í–´–ô –ë–õ–û–ö: –ü–∞–Ω–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ */
      #diagnostic-panel {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 350px;
        background: rgba(0, 20, 40, 0.85);
        border: 1px solid #444;
        border-radius: 5px;
        padding: 10px;
        z-index: 1000;
        font-size: 12px;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      #diagnostic-panel h3 {
        color: #4af;
        margin-bottom: 8px;
        text-align: center;
      }
      
      #log-container {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #333;
        border-radius: 3px;
        padding: 8px;
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      
      .log-entry {
        margin-bottom: 4px;
        padding: 2px;
        border-bottom: 1px dotted #333;
      }
      
      .log-info { color: #8cf; }
      .log-success { color: #4f4; font-weight: bold; }
      .log-warning { color: #ff4; }
      .log-error { color: #f44; font-weight: bold; }
      
      #connection-status {
        padding: 8px;
        margin: 5px 0;
        border-radius: 3px;
        text-align: center;
        background: #222;
      }
      
      .status-disconnected { background: #422 !important; color: #f99; }
      .status-connecting { background: #442 !important; color: #ff4; }
      .status-connected { background: #242 !important; color: #9f9; }
      
      #test-buttons button {
        background: #333;
        color: #ccc;
        border: 1px solid #555;
        border-radius: 3px;
        padding: 6px 10px;
        margin: 3px;
        cursor: pointer;
        font-size: 11px;
      }
      
      #test-buttons button:hover {
        background: #444;
      }
      
      /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ (–ª–æ–∞–¥–µ—Ä –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏ */
      #unity-loading-bar {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }
      
      #loading-text {
        color: white;
        font-family: Arial, sans-serif;
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      #unity-progress-bar-empty {
        width: 200px;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 0 auto;
      }
      
      #unity-progress-bar-full {
        width: 0%;
        height: 100%;
        background: #4CAF50;
        border-radius: 10px;
        transition: width 0.3s;
      }
      
      #unity-warning {
        position: absolute;
        left: 50%;
        top: 5%;
        transform: translate(-50%, 0);
        background: white;
        padding: 10px;
        display: none;
      }
      
      #unity-footer, #unity-webgl-logo, #unity-fullscreen-button, #unity-build-title, #unity-logo {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- –ù–û–í–´–ô –ë–õ–û–ö: –ü–∞–Ω–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
    <div id="diagnostic-panel">
      <h3>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebGL</h3>
      <div id="connection-status" class="status-disconnected">
        ‚óè –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ Unity...
      </div>
      <div>
        <strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong>
        <div id="log-container"></div>
      </div>
      <div id="test-buttons">
        <button onclick="testDirectPing()">–¢–µ—Å—Ç: –ü–∏–Ω–≥ ESP32 –Ω–∞–ø—Ä—è–º—É—é</button>
        <button onclick="testCorsProxy()">–¢–µ—Å—Ç: –ß–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
      </div>
    </div>
    
    <div id="unity-container">
      <canvas id="unity-canvas"></canvas>
      <div id="unity-loading-bar">
        <div id="loading-text">Loading Unity WebGL...</div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"></div>
    </div>
    
    <script>
      // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –§–£–ù–ö–¶–ò–ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ==========
      const esp32Ip = "192.168.1.53"; // –í–∞—à IP ESP32
      let unityInstance = null;
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥
      function addLog(message, type = "info") {
        const logContainer = document.getElementById("log-container");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight; // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        console.log(`[WebGL-Diag] ${message}`);
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      function updateStatus(text, statusClass) {
        const statusElem = document.getElementById("connection-status");
        statusElem.textContent = `‚óè ${text}`;
        statusElem.className = "status-" + statusClass;
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ ESP32
      async function testDirectPing() {
        updateStatus("–¢–µ—Å—Ç: –ü–∏–Ω–≥ ESP32 –Ω–∞–ø—Ä—è–º—É—é...", "connecting");
        addLog(`–ü—ã—Ç–∞—é—Å—å –ø–æ–ª—É—á–∏—Ç—å: http://${esp32Ip}/ping`, "info");
        
        try {
          // –ü—Ä—è–º–æ–π fetch –≤—ã–∑–æ–≤–µ—Ç CORS –æ—à–∏–±–∫—É, —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ
          const response = await fetch(`http://${esp32Ip}/ping`);
          const text = await response.text();
          addLog(`‚úì –£—Å–ø–µ—Ö! –û—Ç–≤–µ—Ç ESP32: ${text}`, "success");
          updateStatus("ESP32 –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)", "connected");
        } catch (error) {
          addLog(`‚úó –û—à–∏–±–∫–∞ (–æ–∂–∏–¥–∞–µ–º–æ): ${error.message}`, "warning");
          updateStatus("ESP32 –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞–ø—Ä—è–º—É—é (–Ω–æ—Ä–º–∞–ª—å–Ω–æ, CORS)", "disconnected");
        }
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏
      async function testCorsProxy() {
        updateStatus("–¢–µ—Å—Ç: –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏...", "connecting");
        const targetUrl = `http://${esp32Ip}/ping`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;
        
        addLog(`–ü—Ä–æ–∫—Å–∏—Ä—É–µ–º —á–µ—Ä–µ–∑: ${proxyUrl}`, "info");
        
        try {
          const response = await fetch(proxyUrl);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const text = await response.text();
          addLog(`‚úì –ü—Ä–æ–∫—Å–∏ –æ—Ç–≤–µ—Ç–∏–ª! –ß–µ—Ä–µ–∑ –Ω–µ–≥–æ ESP32 —Å–∫–∞–∑–∞–ª: ${text}`, "success");
          updateStatus("CORS-–ø—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, ESP32 –æ—Ç–≤–µ—á–∞–µ—Ç", "connected");
        } catch (error) {
          addLog(`‚úó –û—à–∏–±–∫–∞ –ø—Ä–æ–∫—Å–∏: ${error.message}`, "error");
          addLog("–≠—Ç–æ –∑–Ω–∞—á–∏—Ç: 1) –ü—Ä–æ–∫—Å–∏ —É–ø–∞–ª, –∏–ª–∏ 2) ESP32 –Ω–µ –≤–∏–¥–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞", "error");
          updateStatus("–ü—Ä–æ–±–ª–µ–º–∞: –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ ESP32", "disconnected");
        }
      }
      
      function clearLog() {
        document.getElementById("log-container").innerHTML = "";
        addLog("–õ–æ–≥ –æ—á–∏—â–µ–Ω", "info");
      }
      
      // ========== –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ö–û–î –ó–ê–ì–†–£–ó–ö–ò UNITY (—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π) ==========
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var warningBanner = document.querySelector("#unity-warning");

      // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤ Unity
      function unityShowBanner(msg, type) {
        addLog(`Unity Banner: ${msg}`, type === 'error' ? 'error' : 'warning');
        
        // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/test3.loader.js";
      var config = {
        dataUrl: buildUrl + "/test3.data",
        frameworkUrl: buildUrl + "/test3.framework.js",
        codeUrl: buildUrl + "/test3.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "My project (5)",
        productVersion: "1.0",
        showBanner: unityShowBanner,
      };

      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        container.className = "unity-mobile";
        canvas.className = "unity-mobile";
      } else {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
      }

      loadingBar.style.display = "block";
      addLog("–ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É Unity WebGL...", "info");
      updateStatus("–ó–∞–≥—Ä—É–∑–∫–∞ Unity...", "connecting");

      var script = document.createElement("script");
      script.src = loaderUrl;
      
      script.onload = () => {
        addLog("Unity Loader.js –∑–∞–≥—Ä—É–∂–µ–Ω, —Å–æ–∑–¥–∞—é –∏–Ω—Å—Ç–∞–Ω—Å...", "success");
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
          if (progress === 1) {
            addLog("–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ Unity –∑–∞–≤–µ—Ä—à–µ–Ω–∞", "success");
          }
        }).then((instance) => {
          unityInstance = instance;
          loadingBar.style.display = "none";
          addLog("‚úì Unity WebGL —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –∑–∞–ø—É—â–µ–Ω–∞!", "success");
          updateStatus("Unity –≥–æ—Ç–æ–≤–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ESP32 –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã—à–µ.", "connected");
          
          // –ï—Å–ª–∏ –≤ Unity –µ—Å—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –µ–≥–æ
          if (unityInstance.SendMessage) {
            setTimeout(() => {
              try {
                unityInstance.SendMessage("ESP32_WebGL_GitHub", "ManualTest");
                addLog("–û—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–º–∞–Ω–¥—É ManualTest –≤ Unity", "info");
              } catch(e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç/–º–µ—Ç–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω
              }
            }, 1000);
          }
        }).catch((message) => {
          addLog(`–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Unity: ${message}`, "error");
          updateStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Unity", "disconnected");
          alert(message);
        });
      };
      
      script.onerror = () => {
        addLog("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç Unity Loader.js", "error");
        updateStatus("–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω Loader.js", "disconnected");
        unityShowBanner('Failed to load Unity WebGL build. Check console for details.', 'error');
      };
      
      document.body.appendChild(script);
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
      });
      
      // –ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
      addLog("–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞", "info");
      addLog(`–¶–µ–ª–µ–≤–æ–π IP ESP32: ${esp32Ip}`, "info");
    </script>
  </body>
</html>
